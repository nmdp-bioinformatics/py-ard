import sys
from urllib.error import URLError
from urllib.request import urlopen

from ..loader import IMGT_HLA_URL
from ..misc import get_2field_allele, get_3field_allele
from ..simple_table import Table


def load_p_group(imgt_version):
    """
    # load the hla_nom_p.txt

    # file: hla_nom_p.txt
    # date: 2025-10-08
    # version: IPD-IMGT/HLA 3.62.0
    # origin: http://hla.alleles.org/wmda/hla_nom_p.txt
    # repository: https://raw.githubusercontent.com/ANHIG/IMGTHLA/Latest/wmda/hla_nom_p.txt
    # author: IPD Team (ipdsubs@anthonynolan.org)
    A*;01:01:01:01/01:01:01:03/01:01:01:04/01:01:01:05/01:01:01:06/01:01:01:07/01:01:01:08/01:01:01:09/01:01:01:10/01:01:01:11/01:01:01:12/01:01:01:13/01:01:01:14/01:01:01:15/01:01:01:16/01:01:01:17/01:01:01:18/01:01:01:19/01:01:01:20/01:01:01:21/01:01:01:22/01:01:01:23/01:01:01:24/01:01:01:25/01:01:01:26/01:01:01:27/01:01:01:28/01:01:01:29/01:01:01:30/01:01:01:31/01:01:01:32/01:01:01:33/01:01:01:34/01:01:01:35/01:01:01:36/01:01:01:37/01:01:01:38/01:01:01:39/01:01:01:40/01:01:01:41/01:01:01:42/01:01:01:43/01:01:01:44/01:01:01:45/01:01:01:46/01:01:01:47/01:01:01:48/01:01:01:49/01:01:01:50/01:01:01:51/01:01:01:52/01:01:01:53/01:01:01:54/01:01:01:55/01:01:01:56/01:01:01:57/01:01:01:58/01:01:01:59/01:01:01:60/01:01:01:61/01:01:01:62/01:01:01:63/01:01:01:64/01:01:01:65/01:01:01:66/01:01:01:67/01:01:01:68/01:01:01:69/01:01:01:70/01:01:01:71/01:01:01:72/01:01:01:73/01:01:01:74/01:01:01:75/01:01:01:76/01:01:01:77/01:01:01:78/01:01:01:79/01:01:01:80/01:01:01:81/01:01:01:82/01:01:01:83/01:01:01:84/01:01:01:85/01:01:01:86/01:01:01:87/01:01:01:88/01:01:01:89/01:01:01:90/01:01:01:91/01:01:01:92/01:01:01:93/01:01:01:94/01:01:01:95/01:01:01:96/01:01:01:97/01:01:01:98/01:01:01:99/01:01:01:100/01:01:01:101/01:01:01:102/01:01:01:103/01:01:01:104/01:01:01:105/01:01:01:106/01:01:01:107/01:01:01:108/01:01:01:109/01:01:01:110/01:01:01:111/01:01:01:112/01:01:01:113/01:01:01:114/01:01:01:115/01:01:01:116/01:01:01:117/01:01:01:118/01:01:01:119/01:01:01:120/01:01:01:121/01:01:01:122/01:01:02/01:01:03/01:01:04/01:01:05/01:01:06/01:01:07/01:01:08/01:01:09/01:01:10/01:01:11/01:01:12/01:01:13/01:01:14/01:01:15/01:01:16/01:01:17/01:01:18/01:01:19/01:01:20/01:01:21/01:01:22/01:01:23/01:01:24/01:01:25/01:01:26/01:01:27/01:01:28/01:01:29/01:01:30/01:01:31/01:01:32/01:01:33/01:01:34/01:01:35/01:01:36/01:01:37/01:01:38L/01:01:39/01:01:40/01:01:41/01:01:42/01:01:43/01:01:44/01:01:45/01:01:46/01:01:47/01:01:48/01:01:49/01:01:50/01:01:51/01:01:52/01:01:53/01:01:54/01:01:55/01:01:56/01:01:57/01:01:58/01:01:59/01:01:60/01:01:61/01:01:62/01:01:63/01:01:64/01:01:65/01:01:66/01:01:67/01:01:68/01:01:69/01:01:70/01:01:71/01:01:72/01:01:73/01:01:74/01:01:75/01:01:76/01:01:77/01:01:78/01:01:79/01:01:80/01:01:81/01:01:82/01:01:83/01:01:84/01:01:85/01:01:86/01:01:87/01:01:88/01:01:89/01:01:90/01:01:91/01:01:92/01:01:93/01:01:94/01:01:95/01:01:96/01:01:97/01:01:98/01:01:99/01:01:100/01:01:101/01:01:102/01:01:103/01:01:104/01:01:105/01:01:106/01:01:107/01:01:108/01:01:109/01:01:110/01:01:111/01:01:112/01:01:113/01:01:114/01:01:115/01:01:116/01:01:117/01:01:118/01:01:119/01:01:120/01:01:121/01:01:122/01:01:123/01:01:124/01:01:125/01:01:126/01:01:127/01:01:128/01:01:129/01:01:130/01:01:131/01:01:132/01:01:133/01:01:134/01:01:135/01:01:136/01:01:137/01:01:138/01:01:139/01:01:140/01:01:141/01:01:142/01:01:143/01:01:144/01:01:145/01:01:146/01:01:147/01:01:148/01:01:149/01:01:150/01:01:151/01:01:152/01:01:153/01:01:154/01:01:155/01:01:156/01:01:157/01:01:158/01:01:159/01:01:160/01:01:161/01:01:162/01:01:163/01:01:164/01:01:165/01:01:166/01:01:167/01:32/01:37:01:01/01:37:01:02/01:45/01:81/01:103/01:107/01:109/01:132/01:141/01:142/01:155/01:177/01:212/01:217/01:234/01:237/01:246/01:248Q/01:249/01:251/01:252/01:253/01:261/01:274/01:276/01:277/01:280/01:281Q/01:288/01:291/01:295/01:296/01:297/01:300/01:305/01:306/01:309/01:316/01:317/01:319/01:323/01:324:01/01:324:02/01:325/01:331/01:332/01:335/01:338/01:346/01:347/01:349/01:351/01:353/01:356/01:357/01:358/01:367/01:368/01:369/01:370/01:371/01:372/01:377/01:378/01:383/01:385/01:386/01:387/01:388/01:389/01:390/01:392/01:404/01:406/01:407/01:409/01:410/01:415/01:419/01:422/01:426/01:436Q/01:440/01:441/01:443/01:444/01:445/01:446/01:456/01:460/01:461/01:467/01:468/01:471/01:472/01:473Q/01:476Q/01:481;01:01P
    A*;01:02:01:01/01:02:01:02/01:02:01:03/01:02:02/01:412;01:02P
    A*;01:03:01:01/01:03:01:02/01:03:02/01:03:03/01:315;01:03P
    A*;01:06;
    A*;01:07;
    A*;01:08;
    A*;01:09:01:01/01:09:01:02/01:09:02;01:09P
    A*;01:10;
    A*;01:12;
    A*;01:13;

    :param imgt_version: version of IPD/IMGT database
    :return:
    """
    ars_p_url = f"{IMGT_HLA_URL}{imgt_version}/wmda/hla_nom_p.txt"
    try:
        response = urlopen(ars_p_url)
        lines = [line.decode("utf-8").strip() for line in response]
        data_lines = lines[6:]  # Skip first 6 header lines

        data_tuples = []
        for line in data_lines:
            if line:
                fields = line.split(";")
                if len(fields) >= 3 and fields[1] and fields[2]:
                    locus, a_list, p = fields[0], fields[1], fields[2]

                    # Explode slash-delimited alleles
                    for a in a_list.split("/"):
                        full_a = locus + a
                        full_p = locus + p
                        data_tuples.append(
                            (
                                locus,
                                full_a,
                                full_p,
                                get_2field_allele(full_a),
                                get_3field_allele(full_a),
                                get_2field_allele(full_p),
                            )
                        )

        columns = ["Locus", "A", "P", "2d", "3d", "lgx"]
        return Table(data_tuples, columns)

    except URLError as e:
        print(f"Error downloading {ars_p_url}", e, file=sys.stderr)
        sys.exit(1)
